{
  "openapi": "3.1.0",
  "info": {
    "title": "Library Management System API",
    "description": "A **Mini Library Management System** built with FastAPI, PostgreSQL, and OpenAI.\n\n## Authentication\n\nAll protected endpoints require a **Bearer JWT** obtained through the OAuth login flow:\n\n1. Open `GET /api/v1/auth/login/google` (or `/github`) in your **browser**.\n2. Complete the OAuth consent screen.\n3. After login, open your browser Developer Tools â†’ Application â†’ Local Storage.\n4. Copy the value stored under `access_token`.\n5. Paste the token into the **Authorize** dialog (ðŸ”’ button above).\n\nEvery protected endpoint then works directly from this Swagger UI.\n\n## Roles & Permissions\n\n| Role | Capabilities |\n|------|--------------|\n| **Admin** | Full access including user management |\n| **Librarian** | Create / edit / delete books; manage all loans |\n| **Member** | Browse and search books; borrow and return **own** loans |\n\nNew OAuth users start as **Member**. An Admin must promote them via `PATCH /api/v1/admin/users/{id}/role`.\n\n## AI Features\n\nAll three AI endpoints degrade gracefully â€” they never return an error due to missing AI configuration. Check the `source` field (`\"openai\"` vs `\"fallback\"`) to see which path was taken.\n",
    "contact": {
      "name": "Library Management System",
      "url": "https://github.com/maherabbass/Library-Management-System"
    },
    "license": {
      "name": "MIT"
    },
    "version": "0.1.0"
  },
  "paths": {
    "/health": {
      "get": {
        "tags": [
          "health"
        ],
        "summary": "Health check",
        "description": "Lightweight liveness probe. Returns `200 OK` whenever the server process is alive.\n\nUse this endpoint to verify the API is reachable before making authenticated calls.",
        "operationId": "health_check_health_get",
        "responses": {
          "200": {
            "description": "Server is alive and accepting requests.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/books/enrich": {
      "post": {
        "tags": [
          "books",
          "ai"
        ],
        "summary": "Generate AI metadata (no DB write)",
        "description": "Generates a **summary**, **tags**, and **keywords** for a book using OpenAI.\n\nThis endpoint is **preview-only** â€” nothing is written to the database. The librarian reviews the output and then includes it when calling `POST /books` (create) or `PUT /books/{id}` (update).\n\n**Fallback:** if `OPENAI_API_KEY` is not set or the AI call fails, a deterministic heuristic is used instead. Check `source` in the response.\n\n**Requires:** Librarian or Admin role.",
        "operationId": "enrich_book_endpoint_api_v1_books_enrich_post",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/EnrichRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Generated metadata â€” summary, tags, keywords, and the source that produced them.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EnrichResponse"
                }
              }
            }
          },
          "401": {
            "description": "Missing, invalid, or expired Bearer token."
          },
          "403": {
            "description": "Forbidden â€” Librarian or Admin role required."
          },
          "422": {
            "description": "Validation error â€” `title` and `author` are required."
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/api/v1/books/ai-search": {
      "get": {
        "tags": [
          "books",
          "ai"
        ],
        "summary": "Semantic search with embeddings",
        "description": "Ranks books by **semantic similarity** to a natural-language query using OpenAI text embeddings and cosine similarity.\n\nThis endpoint is **public** â€” no authentication required.\n\n**Fallback:** when `OPENAI_API_KEY` is not configured, a standard ILIKE keyword search is performed instead. The `source` field indicates which method was used.\n\n**Example queries:**\n- `books about dystopian futures`\n- `science fiction with strong female protagonists`\n- `classic literature set in 19th century England`",
        "operationId": "ai_search_endpoint_api_v1_books_ai_search_get",
        "parameters": [
          {
            "name": "q",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string",
              "minLength": 1,
              "description": "Natural-language search query.",
              "examples": [
                "books about space exploration"
              ],
              "title": "Q"
            },
            "description": "Natural-language search query."
          },
          {
            "name": "top_k",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "maximum": 50,
              "minimum": 1,
              "description": "Maximum number of results to return (1â€“50).",
              "default": 10,
              "title": "Top K"
            },
            "description": "Maximum number of results to return (1â€“50)."
          }
        ],
        "responses": {
          "200": {
            "description": "Ranked list of matching books with search metadata.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AISearchResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/books/ask": {
      "post": {
        "tags": [
          "books",
          "ai"
        ],
        "summary": "Ask the Library assistant",
        "description": "Ask a natural-language question and receive an answer grounded **exclusively** in books that exist in the database.\n\nThe assistant never invents titles, authors, or availability â€” every claim is backed by a real database record returned in the `books` array.\n\n**Fallback:** when `OPENAI_API_KEY` is not configured, a pre-built template answer is returned using the matched books.\n\n**Example questions:**\n- `Do you have any books by Isaac Asimov?`\n- `What science fiction books are available?`\n- `Can you recommend something about machine learning?`\n\n**Requires:** any authenticated user (Member, Librarian, or Admin).",
        "operationId": "ask_library_endpoint_api_v1_books_ask_post",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/AskRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Grounded answer with the database records that support it.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AskResponse"
                }
              }
            }
          },
          "401": {
            "description": "Missing, invalid, or expired Bearer token."
          },
          "422": {
            "description": "Validation error â€” `question` is required and must be â‰¤500 characters."
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/api/v1/books": {
      "get": {
        "tags": [
          "books"
        ],
        "summary": "List books",
        "description": "Returns a **paginated, filterable** list of books from the catalogue.\n\nThis endpoint is **public** â€” no authentication required.\n\n**Filters (all optional, combinable):**\n\n| Parameter | Behaviour |\n|-----------|----------|\n| `q` | Case-insensitive substring match across title, author, ISBN, and description |\n| `author` | Case-insensitive substring match on the author field only |\n| `tag` | Exact match against the tags array |\n| `status` | `AVAILABLE` or `BORROWED` |\n\nResults are ordered by `created_at` descending (newest first).",
        "operationId": "list_books_endpoint_api_v1_books_get",
        "parameters": [
          {
            "name": "q",
            "in": "query",
            "required": false,
            "schema": {
              "anyOf": [
                {
                  "type": "string"
                },
                {
                  "type": "null"
                }
              ],
              "description": "Free-text search across title, author, ISBN, and description (case-insensitive).",
              "examples": [
                "Frank Herbert"
              ],
              "title": "Q"
            },
            "description": "Free-text search across title, author, ISBN, and description (case-insensitive)."
          },
          {
            "name": "author",
            "in": "query",
            "required": false,
            "schema": {
              "anyOf": [
                {
                  "type": "string"
                },
                {
                  "type": "null"
                }
              ],
              "description": "Filter by author name (case-insensitive substring match).",
              "examples": [
                "Tolkien"
              ],
              "title": "Author"
            },
            "description": "Filter by author name (case-insensitive substring match)."
          },
          {
            "name": "tag",
            "in": "query",
            "required": false,
            "schema": {
              "anyOf": [
                {
                  "type": "string"
                },
                {
                  "type": "null"
                }
              ],
              "description": "Filter by exact tag value.",
              "examples": [
                "science-fiction"
              ],
              "title": "Tag"
            },
            "description": "Filter by exact tag value."
          },
          {
            "name": "status",
            "in": "query",
            "required": false,
            "schema": {
              "anyOf": [
                {
                  "$ref": "#/components/schemas/BookStatus"
                },
                {
                  "type": "null"
                }
              ],
              "description": "Filter by availability status: `AVAILABLE` or `BORROWED`.",
              "title": "Status"
            },
            "description": "Filter by availability status: `AVAILABLE` or `BORROWED`."
          },
          {
            "name": "page",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "description": "Page number (1-based).",
              "default": 1,
              "title": "Page"
            },
            "description": "Page number (1-based)."
          },
          {
            "name": "page_size",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "maximum": 100,
              "minimum": 1,
              "description": "Number of items per page (1â€“100).",
              "default": 20,
              "title": "Page Size"
            },
            "description": "Number of items per page (1â€“100)."
          }
        ],
        "responses": {
          "200": {
            "description": "Paginated book list with total count and page metadata.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BookListResponse"
                }
              }
            }
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": [
          "books"
        ],
        "summary": "Create a book",
        "description": "Adds a new book to the catalogue.\n\nThe book is created with status `AVAILABLE`. Only `title` and `author` are required â€” all other fields are optional.\n\n**Tip:** call `POST /books/enrich` first to generate AI-suggested tags and description, then include them in this request.\n\n**Requires:** Librarian or Admin role.",
        "operationId": "create_book_endpoint_api_v1_books_post",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/BookCreate"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "The newly created book record.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BookResponse"
                }
              }
            }
          },
          "401": {
            "description": "Missing, invalid, or expired Bearer token."
          },
          "403": {
            "description": "Forbidden â€” Librarian or Admin role required."
          },
          "409": {
            "description": "A book with the same ISBN already exists."
          },
          "422": {
            "description": "Validation error â€” check `title` and `author` are non-empty."
          }
        }
      }
    },
    "/api/v1/books/{book_id}": {
      "get": {
        "tags": [
          "books"
        ],
        "summary": "Get a book",
        "description": "Returns the full details of a single book by its UUID.\n\nThis endpoint is **public** â€” no authentication required.",
        "operationId": "get_book_endpoint_api_v1_books__book_id__get",
        "parameters": [
          {
            "name": "book_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid",
              "title": "Book Id"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "The requested book record.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BookResponse"
                }
              }
            }
          },
          "404": {
            "description": "Book not found."
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      },
      "put": {
        "tags": [
          "books"
        ],
        "summary": "Update a book",
        "description": "Partially updates a book's metadata using the provided fields.\n\nOnly fields included in the request body are changed â€” omitted fields keep their current values (partial update / PATCH semantics on a PUT).\n\n**Requires:** Librarian or Admin role.",
        "operationId": "update_book_endpoint_api_v1_books__book_id__put",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "book_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid",
              "title": "Book Id"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/BookUpdate"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "The updated book record.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BookResponse"
                }
              }
            }
          },
          "401": {
            "description": "Missing, invalid, or expired Bearer token."
          },
          "403": {
            "description": "Forbidden â€” Librarian or Admin role required."
          },
          "404": {
            "description": "Book not found."
          },
          "422": {
            "description": "Validation error â€” check field types and constraints."
          }
        }
      },
      "delete": {
        "tags": [
          "books"
        ],
        "summary": "Delete a book",
        "description": "Permanently removes a book from the catalogue.\n\n> **Warning:** this operation is irreversible. Associated loan history is also deleted via cascade.\n\n**Requires:** Librarian or Admin role.",
        "operationId": "delete_book_endpoint_api_v1_books__book_id__delete",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "book_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid",
              "title": "Book Id"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "No content â€” the book was successfully deleted."
          },
          "401": {
            "description": "Missing, invalid, or expired Bearer token."
          },
          "403": {
            "description": "Forbidden â€” Librarian or Admin role required."
          },
          "404": {
            "description": "Book not found."
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/auth/login/{provider}": {
      "get": {
        "tags": [
          "auth"
        ],
        "summary": "Start OAuth login",
        "description": "Redirects the browser to the OAuth provider's authorization page.\n\n**Open this URL directly in a browser** â€” it initiates the OAuth redirect flow. After the user grants consent the provider calls `/callback/{provider}`, which issues a JWT and redirects to the frontend.\n\nSupported providers: `google`, `github`.",
        "operationId": "login_api_v1_auth_login__provider__get",
        "parameters": [
          {
            "name": "provider",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "title": "Provider"
            }
          }
        ],
        "responses": {
          "302": {
            "description": "302 redirect to the provider's authorization page.",
            "content": {
              "application/json": {
                "schema": {}
              }
            }
          },
          "400": {
            "description": "Unsupported or unknown OAuth provider."
          },
          "503": {
            "description": "OAuth provider is not configured on this server (missing client credentials)."
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/auth/callback/{provider}": {
      "get": {
        "tags": [
          "auth"
        ],
        "summary": "OAuth callback â€” issues JWT",
        "description": "Handles the OAuth provider redirect after the user grants consent.\n\nThis endpoint is called **by the OAuth provider**, not directly by the client. It exchanges the authorization code for a user profile, creates the user in the database on first login, then:\n\n- **With frontend configured:** redirects the browser to `{FRONTEND_URL}/auth/callback?token=<jwt>` so the SPA can store the token.\n- **Without frontend (API-only mode):** returns the `TokenResponse` JSON directly.\n\nThe JWT is valid for `ACCESS_TOKEN_EXPIRE_MINUTES` minutes (default: 60).",
        "operationId": "callback_api_v1_auth_callback__provider__get",
        "parameters": [
          {
            "name": "provider",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "title": "Provider"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "JWT Bearer token (or 302 redirect to frontend with `?token=...`).",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TokenResponse"
                }
              }
            }
          },
          "302": {
            "description": "Redirect to frontend SPA with `?token=<jwt>` query parameter."
          },
          "400": {
            "description": "Unsupported or unknown OAuth provider."
          },
          "503": {
            "description": "OAuth provider is not configured on this server (missing client credentials)."
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/auth/me": {
      "get": {
        "tags": [
          "auth"
        ],
        "summary": "Get current user",
        "description": "Returns the profile of the currently authenticated user decoded from the Bearer token.\n\nUse this endpoint to:\n- Verify a token is valid.\n- Retrieve the user's `id`, `email`, `name`, `role`, and `oauth_provider`.\n\n**Requires:** `Authorization: Bearer <token>`",
        "operationId": "me_api_v1_auth_me_get",
        "responses": {
          "200": {
            "description": "The authenticated user's profile.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UserResponse"
                }
              }
            }
          },
          "401": {
            "description": "Missing, invalid, or expired Bearer token."
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/api/v1/admin/users": {
      "get": {
        "tags": [
          "admin"
        ],
        "summary": "List all users",
        "description": "Returns every user account registered in the system, ordered by creation date.\n\nUse this endpoint to:\n- Review all accounts and their current roles.\n- Find user IDs for the `PATCH /admin/users/{id}/role` endpoint.\n\n**Requires:** Admin role.",
        "operationId": "get_users_api_v1_admin_users_get",
        "responses": {
          "200": {
            "description": "Array of all user profiles.",
            "content": {
              "application/json": {
                "schema": {
                  "items": {
                    "$ref": "#/components/schemas/UserResponse"
                  },
                  "type": "array",
                  "title": "Response Get Users Api V1 Admin Users Get"
                }
              }
            }
          },
          "401": {
            "description": "Missing, invalid, or expired Bearer token."
          },
          "403": {
            "description": "Forbidden â€” Admin role required."
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/api/v1/admin/users/{user_id}/role": {
      "patch": {
        "tags": [
          "admin"
        ],
        "summary": "Change a user's role",
        "description": "Promotes or demotes a user by updating their RBAC role.\n\n**Available roles:**\n\n| Role | Description |\n|------|-------------|\n| `MEMBER` | Default role â€” can browse and borrow books |\n| `LIBRARIAN` | Can create/edit/delete books and manage all loans |\n| `ADMIN` | Full access including this user management endpoint |\n\n> **Warning:** demoting the last Admin account will lock everyone out of admin features.\n\n**Requires:** Admin role.",
        "operationId": "patch_user_role_api_v1_admin_users__user_id__role_patch",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "user_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid",
              "title": "User Id"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RoleUpdate"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "The updated user profile reflecting the new role.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UserResponse"
                }
              }
            }
          },
          "401": {
            "description": "Missing, invalid, or expired Bearer token."
          },
          "403": {
            "description": "Forbidden â€” Admin role required."
          },
          "404": {
            "description": "User not found."
          },
          "422": {
            "description": "Validation error â€” `role` must be one of `ADMIN`, `LIBRARIAN`, `MEMBER`."
          }
        }
      }
    },
    "/api/v1/loans/checkout": {
      "post": {
        "tags": [
          "loans"
        ],
        "summary": "Borrow a book",
        "description": "Creates a new loan and marks the book as `BORROWED`.\n\n**Business rules:**\n- The book must currently have status `AVAILABLE`. If it is already `BORROWED`, the request fails with `409 Conflict`.\n- There is no limit on how many books a single user can borrow simultaneously.\n- Any authenticated user (Member, Librarian, or Admin) can borrow a book.\n\n**Concurrency:** the endpoint uses `SELECT ... FOR UPDATE` to prevent two users from borrowing the same book simultaneously.\n\n**Requires:** any authenticated user.",
        "operationId": "checkout_endpoint_api_v1_loans_checkout_post",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CheckoutRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "201": {
            "description": "The new loan record with status `OUT`.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/LoanResponse"
                }
              }
            }
          },
          "401": {
            "description": "Missing, invalid, or expired Bearer token."
          },
          "404": {
            "description": "Book not found."
          },
          "409": {
            "description": "Conflict â€” the book is already borrowed by another user."
          },
          "422": {
            "description": "Validation error â€” `book_id` must be a valid UUID."
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/api/v1/loans/return": {
      "post": {
        "tags": [
          "loans"
        ],
        "summary": "Return a book",
        "description": "Closes an active loan and marks the book as `AVAILABLE` again.\n\n**Business rules:**\n- The loan must have status `OUT`. Already-returned loans return `404`.\n- **Members** may only return their **own** loans â€” supplying another user's loan ID returns `403 Forbidden`.\n- **Librarians** and **Admins** may return any loan.\n\n**Requires:** any authenticated user.",
        "operationId": "return_endpoint_api_v1_loans_return_post",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ReturnRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "The closed loan record with status `RETURNED` and `returned_at` timestamp.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/LoanResponse"
                }
              }
            }
          },
          "401": {
            "description": "Missing, invalid, or expired Bearer token."
          },
          "403": {
            "description": "Forbidden â€” Members may only return their own loans."
          },
          "404": {
            "description": "Loan not found or already returned."
          },
          "422": {
            "description": "Validation error â€” `loan_id` must be a valid UUID."
          }
        },
        "security": [
          {
            "HTTPBearer": []
          }
        ]
      }
    },
    "/api/v1/loans": {
      "get": {
        "tags": [
          "loans"
        ],
        "summary": "List loans",
        "description": "Returns a paginated list of loans.\n\n**Role-based filtering:**\n- **Members** see only their **own** loans.\n- **Librarians** and **Admins** see **all** loans across all users.\n\nResults are ordered by `checked_out_at` descending (most recent first).\n\n**Requires:** any authenticated user.",
        "operationId": "list_loans_endpoint_api_v1_loans_get",
        "security": [
          {
            "HTTPBearer": []
          }
        ],
        "parameters": [
          {
            "name": "page",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "description": "Page number (1-based).",
              "default": 1,
              "title": "Page"
            },
            "description": "Page number (1-based)."
          },
          {
            "name": "page_size",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "maximum": 100,
              "minimum": 1,
              "description": "Items per page (1â€“100).",
              "default": 20,
              "title": "Page Size"
            },
            "description": "Items per page (1â€“100)."
          }
        ],
        "responses": {
          "200": {
            "description": "Paginated loan list.",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/LoanListResponse"
                }
              }
            }
          },
          "401": {
            "description": "Missing, invalid, or expired Bearer token."
          },
          "422": {
            "description": "Validation Error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HTTPValidationError"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "AISearchResponse": {
        "properties": {
          "items": {
            "items": {
              "$ref": "#/components/schemas/BookResponse"
            },
            "type": "array",
            "title": "Items",
            "description": "Books ranked by semantic similarity to the query (most similar first)."
          },
          "total": {
            "type": "integer",
            "title": "Total",
            "description": "Number of books returned."
          },
          "source": {
            "type": "string",
            "enum": [
              "openai",
              "fallback"
            ],
            "title": "Source",
            "description": "`openai` â€” results ranked by cosine similarity of OpenAI embeddings. `fallback` â€” `OPENAI_API_KEY` is not set; ILIKE keyword search was used instead."
          },
          "query": {
            "type": "string",
            "title": "Query",
            "description": "The original query string that was searched."
          }
        },
        "type": "object",
        "required": [
          "items",
          "total",
          "source",
          "query"
        ],
        "title": "AISearchResponse",
        "example": {
          "items": [],
          "query": "books about space exploration and survival",
          "source": "openai",
          "total": 3
        }
      },
      "AskRequest": {
        "properties": {
          "question": {
            "type": "string",
            "maxLength": 500,
            "minLength": 1,
            "title": "Question",
            "description": "A natural-language question about the library collection.",
            "examples": [
              "Do you have any books about artificial intelligence?"
            ]
          }
        },
        "type": "object",
        "required": [
          "question"
        ],
        "title": "AskRequest",
        "example": {
          "question": "Do you have any books about artificial intelligence?"
        }
      },
      "AskResponse": {
        "properties": {
          "answer": {
            "type": "string",
            "title": "Answer",
            "description": "Natural-language answer grounded **only** in books found in the database. The assistant never invents titles or authors."
          },
          "books": {
            "items": {
              "$ref": "#/components/schemas/BookResponse"
            },
            "type": "array",
            "title": "Books",
            "description": "The actual database records used to formulate the answer. Always inspect this list to verify the answer is grounded."
          },
          "source": {
            "type": "string",
            "enum": [
              "openai",
              "fallback"
            ],
            "title": "Source",
            "description": "`openai` â€” answer was generated by the configured OpenAI model. `fallback` â€” a pre-built template answer was returned without AI."
          }
        },
        "type": "object",
        "required": [
          "answer",
          "books",
          "source"
        ],
        "title": "AskResponse",
        "example": {
          "answer": "Yes! We have 2 books about artificial intelligence: 'Superintelligence' by Nick Bostrom and 'Life 3.0' by Max Tegmark.",
          "books": [],
          "source": "openai"
        }
      },
      "BookCreate": {
        "properties": {
          "title": {
            "type": "string",
            "minLength": 1,
            "title": "Title",
            "description": "Book title.",
            "examples": [
              "Dune"
            ]
          },
          "author": {
            "type": "string",
            "minLength": 1,
            "title": "Author",
            "description": "Full name of the primary author.",
            "examples": [
              "Frank Herbert"
            ]
          },
          "isbn": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Isbn",
            "description": "ISBN-10 or ISBN-13. Must be unique across all books if provided.",
            "examples": [
              "978-0441013593"
            ]
          },
          "published_year": {
            "anyOf": [
              {
                "type": "integer",
                "maximum": 2100.0,
                "minimum": 1000.0
              },
              {
                "type": "null"
              }
            ],
            "title": "Published Year",
            "description": "Year the book was first published.",
            "examples": [
              1965
            ]
          },
          "description": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Description",
            "description": "Short synopsis or notes about the book.",
            "examples": [
              "A science fiction epic set on the desert planet Arrakis."
            ]
          },
          "tags": {
            "anyOf": [
              {
                "items": {
                  "type": "string"
                },
                "type": "array"
              },
              {
                "type": "null"
              }
            ],
            "title": "Tags",
            "description": "Free-form classification tags (e.g. genre, topic).",
            "examples": [
              [
                "science-fiction",
                "epic",
                "classic"
              ]
            ]
          }
        },
        "type": "object",
        "required": [
          "title",
          "author"
        ],
        "title": "BookCreate",
        "example": {
          "author": "Frank Herbert",
          "description": "A science fiction epic set on the desert planet Arrakis.",
          "isbn": "978-0441013593",
          "published_year": 1965,
          "tags": [
            "science-fiction",
            "epic",
            "classic"
          ],
          "title": "Dune"
        }
      },
      "BookListResponse": {
        "properties": {
          "items": {
            "items": {
              "$ref": "#/components/schemas/BookResponse"
            },
            "type": "array",
            "title": "Items",
            "description": "Books on the current page."
          },
          "total": {
            "type": "integer",
            "title": "Total",
            "description": "Total number of books matching the current filters."
          },
          "page": {
            "type": "integer",
            "title": "Page",
            "description": "Current page number (1-based)."
          },
          "page_size": {
            "type": "integer",
            "title": "Page Size",
            "description": "Maximum items returned per page."
          },
          "pages": {
            "type": "integer",
            "title": "Pages",
            "description": "Total number of pages."
          }
        },
        "type": "object",
        "required": [
          "items",
          "total",
          "page",
          "page_size",
          "pages"
        ],
        "title": "BookListResponse",
        "example": {
          "items": [],
          "page": 1,
          "page_size": 20,
          "pages": 3,
          "total": 42
        }
      },
      "BookResponse": {
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "title": "Id",
            "description": "Unique book identifier (UUID v4)."
          },
          "title": {
            "type": "string",
            "title": "Title",
            "description": "Book title."
          },
          "author": {
            "type": "string",
            "title": "Author",
            "description": "Primary author."
          },
          "isbn": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Isbn",
            "description": "ISBN-10 or ISBN-13, if provided."
          },
          "published_year": {
            "anyOf": [
              {
                "type": "integer"
              },
              {
                "type": "null"
              }
            ],
            "title": "Published Year",
            "description": "Year first published."
          },
          "description": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Description",
            "description": "Synopsis or notes."
          },
          "tags": {
            "anyOf": [
              {
                "items": {
                  "type": "string"
                },
                "type": "array"
              },
              {
                "type": "null"
              }
            ],
            "title": "Tags",
            "description": "Classification tags."
          },
          "status": {
            "$ref": "#/components/schemas/BookStatus",
            "description": "Current availability: `AVAILABLE` â€” can be borrowed; `BORROWED` â€” checked out."
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "title": "Created At",
            "description": "Timestamp when the record was created (UTC)."
          },
          "updated_at": {
            "type": "string",
            "format": "date-time",
            "title": "Updated At",
            "description": "Timestamp of the last update (UTC)."
          }
        },
        "type": "object",
        "required": [
          "id",
          "title",
          "author",
          "status",
          "created_at",
          "updated_at"
        ],
        "title": "BookResponse",
        "example": {
          "author": "Frank Herbert",
          "created_at": "2024-01-15T10:30:00Z",
          "description": "A science fiction epic set on the desert planet Arrakis.",
          "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
          "isbn": "978-0441013593",
          "published_year": 1965,
          "status": "AVAILABLE",
          "tags": [
            "science-fiction",
            "epic",
            "classic"
          ],
          "title": "Dune",
          "updated_at": "2024-01-15T10:30:00Z"
        }
      },
      "BookStatus": {
        "type": "string",
        "enum": [
          "AVAILABLE",
          "BORROWED"
        ],
        "title": "BookStatus"
      },
      "BookUpdate": {
        "properties": {
          "title": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Title",
            "description": "New title. Omit to keep the current value."
          },
          "author": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Author",
            "description": "New author. Omit to keep the current value."
          },
          "isbn": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Isbn",
            "description": "New ISBN. Omit to keep the current value."
          },
          "published_year": {
            "anyOf": [
              {
                "type": "integer"
              },
              {
                "type": "null"
              }
            ],
            "title": "Published Year",
            "description": "New publication year. Omit to keep the current value."
          },
          "description": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Description",
            "description": "New description. Omit to keep the current value."
          },
          "tags": {
            "anyOf": [
              {
                "items": {
                  "type": "string"
                },
                "type": "array"
              },
              {
                "type": "null"
              }
            ],
            "title": "Tags",
            "description": "Replaces the **entire** tag list. Send an empty list `[]` to clear tags."
          },
          "status": {
            "anyOf": [
              {
                "$ref": "#/components/schemas/BookStatus"
              },
              {
                "type": "null"
              }
            ],
            "description": "Override the book status. Normally managed automatically by checkout/return â€” use with care."
          }
        },
        "type": "object",
        "title": "BookUpdate",
        "example": {
          "description": "Updated synopsis of the Dune novel.",
          "tags": [
            "science-fiction",
            "epic",
            "desert"
          ]
        }
      },
      "CheckoutRequest": {
        "properties": {
          "book_id": {
            "type": "string",
            "format": "uuid",
            "title": "Book Id",
            "description": "UUID of the book to borrow. The book must have status `AVAILABLE`.",
            "examples": [
              "3fa85f64-5717-4562-b3fc-2c963f66afa6"
            ]
          }
        },
        "type": "object",
        "required": [
          "book_id"
        ],
        "title": "CheckoutRequest",
        "example": {
          "book_id": "3fa85f64-5717-4562-b3fc-2c963f66afa6"
        }
      },
      "EnrichRequest": {
        "properties": {
          "title": {
            "type": "string",
            "minLength": 1,
            "title": "Title",
            "description": "Book title to enrich.",
            "examples": [
              "Dune"
            ]
          },
          "author": {
            "type": "string",
            "minLength": 1,
            "title": "Author",
            "description": "Primary author of the book.",
            "examples": [
              "Frank Herbert"
            ]
          },
          "description": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Description",
            "description": "Optional synopsis or notes that help the AI generate richer metadata.",
            "examples": [
              "A science fiction epic set on the desert planet Arrakis."
            ]
          }
        },
        "type": "object",
        "required": [
          "title",
          "author"
        ],
        "title": "EnrichRequest",
        "example": {
          "author": "Frank Herbert",
          "description": "A science fiction epic set on the desert planet Arrakis.",
          "title": "Dune"
        }
      },
      "EnrichResponse": {
        "properties": {
          "summary": {
            "type": "string",
            "title": "Summary",
            "description": "AI-generated one-paragraph summary of the book. When `source` is `fallback` this equals the provided description."
          },
          "tags": {
            "items": {
              "type": "string"
            },
            "type": "array",
            "title": "Tags",
            "description": "Suggested classification tags (genre, topic, era, â€¦)."
          },
          "keywords": {
            "items": {
              "type": "string"
            },
            "type": "array",
            "title": "Keywords",
            "description": "Key terms extracted from the title/author/description for search indexing."
          },
          "source": {
            "type": "string",
            "enum": [
              "openai",
              "fallback"
            ],
            "title": "Source",
            "description": "`openai` â€” result was generated by the configured OpenAI model. `fallback` â€” `OPENAI_API_KEY` is not set or an error occurred; deterministic heuristics were used instead."
          }
        },
        "type": "object",
        "required": [
          "summary",
          "tags",
          "keywords",
          "source"
        ],
        "title": "EnrichResponse",
        "example": {
          "keywords": [
            "dune",
            "arrakis",
            "spice",
            "paul",
            "atreides",
            "herbert"
          ],
          "source": "openai",
          "summary": "A science fiction epic following Paul Atreides on the desert planet Arrakis, where control of the spice melange determines the fate of the universe.",
          "tags": [
            "science-fiction",
            "epic",
            "classic",
            "space-opera"
          ]
        }
      },
      "HTTPValidationError": {
        "properties": {
          "detail": {
            "items": {
              "$ref": "#/components/schemas/ValidationError"
            },
            "type": "array",
            "title": "Detail"
          }
        },
        "type": "object",
        "title": "HTTPValidationError"
      },
      "HealthResponse": {
        "properties": {
          "status": {
            "type": "string",
            "title": "Status",
            "description": "Always `\"ok\"` when the server is running."
          },
          "version": {
            "type": "string",
            "title": "Version",
            "description": "Deployed application version."
          }
        },
        "type": "object",
        "required": [
          "status",
          "version"
        ],
        "title": "HealthResponse"
      },
      "LoanListResponse": {
        "properties": {
          "items": {
            "items": {
              "$ref": "#/components/schemas/LoanResponse"
            },
            "type": "array",
            "title": "Items",
            "description": "Loans on the current page."
          },
          "total": {
            "type": "integer",
            "title": "Total",
            "description": "Total number of loans matching the current query."
          }
        },
        "type": "object",
        "required": [
          "items",
          "total"
        ],
        "title": "LoanListResponse",
        "example": {
          "items": [],
          "total": 0
        }
      },
      "LoanResponse": {
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "title": "Id",
            "description": "Unique loan identifier (UUID v4)."
          },
          "book_id": {
            "type": "string",
            "format": "uuid",
            "title": "Book Id",
            "description": "UUID of the borrowed book."
          },
          "user_id": {
            "type": "string",
            "format": "uuid",
            "title": "User Id",
            "description": "UUID of the user who borrowed the book."
          },
          "checked_out_at": {
            "type": "string",
            "format": "date-time",
            "title": "Checked Out At",
            "description": "UTC timestamp when the book was checked out."
          },
          "returned_at": {
            "anyOf": [
              {
                "type": "string",
                "format": "date-time"
              },
              {
                "type": "null"
              }
            ],
            "title": "Returned At",
            "description": "UTC timestamp when the book was returned. `null` if still checked out."
          },
          "status": {
            "$ref": "#/components/schemas/LoanStatus",
            "description": "Loan status: `OUT` â€” book is still borrowed; `RETURNED` â€” book has been returned."
          }
        },
        "type": "object",
        "required": [
          "id",
          "book_id",
          "user_id",
          "checked_out_at",
          "status"
        ],
        "title": "LoanResponse",
        "example": {
          "book_id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
          "checked_out_at": "2024-01-20T09:00:00Z",
          "id": "8a1bc234-9876-4def-b3fc-1a2b3c4d5e6f",
          "status": "OUT",
          "user_id": "1b2c3d4e-5f6a-7b8c-9d0e-1f2a3b4c5d6e"
        }
      },
      "LoanStatus": {
        "type": "string",
        "enum": [
          "OUT",
          "RETURNED"
        ],
        "title": "LoanStatus"
      },
      "ReturnRequest": {
        "properties": {
          "loan_id": {
            "type": "string",
            "format": "uuid",
            "title": "Loan Id",
            "description": "UUID of the active loan to close. Members may only supply their **own** loan IDs. Librarians and Admins may supply any loan ID.",
            "examples": [
              "8a1bc234-9876-4def-b3fc-1a2b3c4d5e6f"
            ]
          }
        },
        "type": "object",
        "required": [
          "loan_id"
        ],
        "title": "ReturnRequest",
        "example": {
          "loan_id": "8a1bc234-9876-4def-b3fc-1a2b3c4d5e6f"
        }
      },
      "RoleUpdate": {
        "properties": {
          "role": {
            "$ref": "#/components/schemas/UserRole",
            "description": "The new role to assign to the user: `ADMIN` | `LIBRARIAN` | `MEMBER`.",
            "examples": [
              "LIBRARIAN"
            ]
          }
        },
        "type": "object",
        "required": [
          "role"
        ],
        "title": "RoleUpdate",
        "example": {
          "role": "LIBRARIAN"
        }
      },
      "TokenResponse": {
        "properties": {
          "access_token": {
            "type": "string",
            "title": "Access Token",
            "description": "JWT Bearer token. Include it in subsequent requests as:\n\n`Authorization: Bearer <access_token>`",
            "examples": [
              "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            ]
          },
          "token_type": {
            "type": "string",
            "title": "Token Type",
            "description": "Token scheme. Always `\"bearer\"`.",
            "default": "bearer",
            "examples": [
              "bearer"
            ]
          }
        },
        "type": "object",
        "required": [
          "access_token"
        ],
        "title": "TokenResponse",
        "example": {
          "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxYjJjM2Q0ZS01ZjZhLTdiOGMtOWQwZS0xZjJhM2I0YzVkNmUiLCJleHAiOjE3MDU5MjE2MDB9.signature",
          "token_type": "bearer"
        }
      },
      "UserResponse": {
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "title": "Id",
            "description": "Unique user identifier (UUID v4)."
          },
          "email": {
            "type": "string",
            "title": "Email",
            "description": "User's verified email address."
          },
          "name": {
            "type": "string",
            "title": "Name",
            "description": "Display name from the OAuth provider."
          },
          "role": {
            "$ref": "#/components/schemas/UserRole",
            "description": "RBAC role: `ADMIN` | `LIBRARIAN` | `MEMBER`. New users start as `MEMBER`."
          },
          "oauth_provider": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Oauth Provider",
            "description": "OAuth provider used to sign in: `google` or `github`."
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "title": "Created At",
            "description": "UTC timestamp when the account was created."
          }
        },
        "type": "object",
        "required": [
          "id",
          "email",
          "name",
          "role",
          "created_at"
        ],
        "title": "UserResponse",
        "example": {
          "created_at": "2024-01-10T08:00:00Z",
          "email": "alice@example.com",
          "id": "1b2c3d4e-5f6a-7b8c-9d0e-1f2a3b4c5d6e",
          "name": "Alice Smith",
          "oauth_provider": "google",
          "role": "MEMBER"
        }
      },
      "UserRole": {
        "type": "string",
        "enum": [
          "ADMIN",
          "LIBRARIAN",
          "MEMBER"
        ],
        "title": "UserRole"
      },
      "ValidationError": {
        "properties": {
          "loc": {
            "items": {
              "anyOf": [
                {
                  "type": "string"
                },
                {
                  "type": "integer"
                }
              ]
            },
            "type": "array",
            "title": "Location"
          },
          "msg": {
            "type": "string",
            "title": "Message"
          },
          "type": {
            "type": "string",
            "title": "Error Type"
          },
          "input": {
            "title": "Input"
          },
          "ctx": {
            "type": "object",
            "title": "Context"
          }
        },
        "type": "object",
        "required": [
          "loc",
          "msg",
          "type"
        ],
        "title": "ValidationError"
      }
    },
    "securitySchemes": {
      "HTTPBearer": {
        "type": "http",
        "scheme": "bearer"
      },
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "JWT access token obtained from `GET /api/v1/auth/callback/{provider}`. Obtain it by completing the OAuth login flow and copying the `token` query parameter from the redirect URL."
      }
    }
  },
  "tags": [
    {
      "name": "health",
      "description": "Server liveness probe. No authentication required."
    },
    {
      "name": "auth",
      "description": "OAuth 2.0 SSO login via **Google** or **GitHub**.\n\nThe callback endpoint issues a short-lived **JWT Bearer token**. Pass it in every protected request:\n\n```\nAuthorization: Bearer <token>\n```\n\nClick the **Authorize** button at the top of this page and paste your token to unlock all authenticated endpoints directly in Swagger UI."
    },
    {
      "name": "books",
      "description": "Full CRUD for the book catalogue plus text search and pagination.\n\n- **GET** endpoints are **public** â€” no token required.\n- **POST / PUT / DELETE** require **Librarian** or **Admin** role."
    },
    {
      "name": "loans",
      "description": "Check-out and return workflows.\n\n- Any authenticated user may borrow an available book.\n- **Members** may only return their **own** loans.\n- **Librarians** and **Admins** may return any loan.\n\n> **Business rule:** a book can have **at most one active loan** at a time. Attempting to borrow an already-borrowed book returns `409 Conflict`."
    },
    {
      "name": "ai",
      "description": "Three AI-powered features, all backed by OpenAI with **graceful fallback** to deterministic heuristics when `OPENAI_API_KEY` is not configured.\n\n| Endpoint | Description | Auth |\n|----------|-------------|------|\n| `POST /books/enrich` | Generate summary, tags & keywords before saving | Librarian / Admin |\n| `GET /books/ai-search` | Rank books by embedding similarity | Public |\n| `POST /books/ask` | Grounded library chat assistant | Any authenticated user |\n\nThe `source` field in every AI response tells you whether OpenAI or the fallback was used."
    },
    {
      "name": "admin",
      "description": "User management. Restricted to **Admin** role only.\n\nNew OAuth users are created as **Member**. Use `PATCH /admin/users/{id}/role` to promote them to Librarian or Admin."
    }
  ]
}