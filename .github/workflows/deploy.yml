name: CI / CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# ─── Project-level constants ─────────────────────────────────────────────────
env:
  PROJECT_ID: library-system-488110-p7
  REGION: europe-west1
  SERVICE_NAME: library-app
  AR_REGISTRY: europe-west1-docker.pkg.dev
  AR_REPOSITORY: library-app          # Artifact Registry repo name
  CLOUD_SQL_INSTANCE: library-system-488110-p7:europe-west1:library-postgres
  MIGRATION_JOB: library-migrate

jobs:
  # ─── Lint + test — runs on every push and every PR ─────────────────────────
  test:
    name: Lint & Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Lint (ruff)
        run: ruff check .

      - name: Format check (black)
        run: black --check .

      - name: Run tests
        run: pytest
        env:
          SECRET_KEY: ci-test-secret-key
          # DATABASE_URL intentionally absent → DB-dependent tests are skipped

  # ─── Build + migrate + deploy — main branch pushes only ────────────────────
  deploy:
    name: Build & Deploy
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      contents: read
      id-token: write   # required for Workload Identity Federation

    steps:
      - uses: actions/checkout@v4

      # Keyless auth via WIF — no JSON service-account key stored anywhere
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.AR_REGISTRY }} --quiet

      # ── Build & push image ────────────────────────────────────────────────
      - name: Build and push Docker image
        id: build
        run: |
          IMAGE="${{ env.AR_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.AR_REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

      # ── Migrate BEFORE deploy ─────────────────────────────────────────────
      # Rationale: additive migrations (new columns / tables) are backward-
      # compatible with the current running code. Running them first means the
      # schema is ready when traffic starts reaching the new revision, and the
      # old revision continues to work during the rollout window.
      - name: Run database migrations (Cloud Run Job)
        env:
          DB_URL: ${{ secrets.DATABASE_URL }}
        run: |
          IMAGE="${{ steps.build.outputs.image }}"
          JOB="${{ env.MIGRATION_JOB }}"
          REGION="${{ env.REGION }}"
          PROJECT="${{ env.PROJECT_ID }}"
          SQL_INST="${{ env.CLOUD_SQL_INSTANCE }}"

          # Create job on first run; update image + config on subsequent runs
          if gcloud run jobs describe "$JOB" \
               --region="$REGION" --project="$PROJECT" 2>/dev/null; then
            gcloud run jobs update "$JOB" \
              --image="$IMAGE" \
              --region="$REGION" \
              --project="$PROJECT" \
              --command="alembic" \
              --args="upgrade,head" \
              --set-env-vars="DATABASE_URL=${DB_URL}" \
              --set-cloudsql-instances="$SQL_INST" \
              --max-retries=0 \
              --task-timeout=5m
          else
            gcloud run jobs create "$JOB" \
              --image="$IMAGE" \
              --region="$REGION" \
              --project="$PROJECT" \
              --command="alembic" \
              --args="upgrade,head" \
              --set-env-vars="DATABASE_URL=${DB_URL}" \
              --set-cloudsql-instances="$SQL_INST" \
              --max-retries=0 \
              --task-timeout=5m
          fi

          # Block until the migration execution finishes (exit 1 on failure)
          gcloud run jobs execute "$JOB" \
            --region="$REGION" \
            --project="$PROJECT" \
            --wait

      # ── Deploy Cloud Run service ──────────────────────────────────────────
      - name: Deploy to Cloud Run
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          # GitHub secrets cannot start with GITHUB_; stored as GH_CLIENT_*
          GH_CLIENT_ID: ${{ secrets.GH_CLIENT_ID }}
          GH_CLIENT_SECRET: ${{ secrets.GH_CLIENT_SECRET }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # Comma-separated extra CORS origins beyond FRONTEND_URL + localhost.
          EXTRA_CORS_ORIGINS: ${{ secrets.EXTRA_CORS_ORIGINS }}
          # Regex for dynamic origins — Vercel preview deployments, staging URLs, etc.
          # Example value: https://library-management-system[^.]*\.vercel\.app
          CORS_ORIGIN_REGEX: ${{ secrets.CORS_ORIGIN_REGEX }}
        run: |
          # Use | as the key=value pair separator so that values which contain
          # commas (e.g. EXTRA_CORS_ORIGINS, DATABASE_URL) are passed verbatim.
          # The ^|^ prefix tells gcloud to treat | as the delimiter instead of ,.
          CLOUD_RUN_ENV="APP_ENV=production"
          CLOUD_RUN_ENV="${CLOUD_RUN_ENV}|DATABASE_URL=${DATABASE_URL}"
          CLOUD_RUN_ENV="${CLOUD_RUN_ENV}|SECRET_KEY=${SECRET_KEY}"
          CLOUD_RUN_ENV="${CLOUD_RUN_ENV}|GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}"
          CLOUD_RUN_ENV="${CLOUD_RUN_ENV}|GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}"
          CLOUD_RUN_ENV="${CLOUD_RUN_ENV}|GITHUB_CLIENT_ID=${GH_CLIENT_ID}"
          CLOUD_RUN_ENV="${CLOUD_RUN_ENV}|GITHUB_CLIENT_SECRET=${GH_CLIENT_SECRET}"
          CLOUD_RUN_ENV="${CLOUD_RUN_ENV}|FRONTEND_URL=${FRONTEND_URL}"
          CLOUD_RUN_ENV="${CLOUD_RUN_ENV}|BACKEND_URL=${BACKEND_URL}"
          CLOUD_RUN_ENV="${CLOUD_RUN_ENV}|EXTRA_CORS_ORIGINS=${EXTRA_CORS_ORIGINS}"
          CLOUD_RUN_ENV="${CLOUD_RUN_ENV}|CORS_ORIGIN_REGEX=${CORS_ORIGIN_REGEX}"
          CLOUD_RUN_ENV="${CLOUD_RUN_ENV}|AI_PROVIDER=openai"
          CLOUD_RUN_ENV="${CLOUD_RUN_ENV}|OPENAI_API_KEY=${OPENAI_API_KEY}"
          CLOUD_RUN_ENV="${CLOUD_RUN_ENV}|OPENAI_MODEL=gpt-4o-mini"

          gcloud run deploy "${{ env.SERVICE_NAME }}" \
            --image="${{ steps.build.outputs.image }}" \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}" \
            --platform=managed \
            --allow-unauthenticated \
            --add-cloudsql-instances="${{ env.CLOUD_SQL_INSTANCE }}" \
            --set-env-vars="^|^${CLOUD_RUN_ENV}" \
            --min-instances=0 \
            --max-instances=3 \
            --timeout=60

      - name: Print deployed URL
        run: |
          gcloud run services describe "${{ env.SERVICE_NAME }}" \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}" \
            --format="value(status.url)"
